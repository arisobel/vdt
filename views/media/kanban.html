{{extend 'layout.html'}}

{{block head}}
<link rel="stylesheet" href="{{=URL('static','css/jquery-ui.css')}}"/>
<link rel="stylesheet" href="{{=URL('static','plugins/chosen/chosen.css')}}"/>
<style>
.kanban-board {
    display: flex;
    gap: 20px;
    padding: 20px;
    overflow-x: auto;
    min-height: 600px;
    max-height: 80vh;
    overflow-y: hidden;
}

.kanban-column {
    min-width: 300px;
    max-width: 300px;
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    max-height: calc(80vh - 40px);
}

/* Mobile responsive styles */
@media (max-width: 768px) {
    .kanban-board {
        gap: 15px;
        padding: 10px;
        min-height: auto;
        max-height: none;
    }
    
    .kanban-column {
        min-width: 280px;
        max-width: 280px;
        padding: 12px;
        max-height: none;
    }
    
    .kanban-column-header {
        font-size: 13px;
        padding: 8px;
    }
    
    .kanban-cards {
        min-height: 300px;
        max-height: none;
    }
}

@media (max-width: 480px) {
    .kanban-board {
        gap: 10px;
        padding: 5px;
    }
    
    .kanban-column {
        min-width: calc(100vw - 30px);
        max-width: calc(100vw - 30px);
        padding: 10px;
    }
}

.kanban-column-header {
    font-weight: bold;
    font-size: 14px;
    padding: 10px;
    margin-bottom: 15px;
    background-color: #e9ecef;
    border-radius: 5px;
    text-align: center;
    color: #495057;
}

.kanban-cards {
    min-height: 500px;
    max-height: calc(80vh - 150px);
    padding: 5px;
    overflow-y: auto;
    flex: 1;
}

.kanban-card {
    background: white;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: move;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    border-left: 4px solid #007bff;
    transition: all 0.2s ease;
    position: relative;
    touch-action: none; /* Better touch support */
}

/* Mobile: larger touch targets */
@media (max-width: 768px) {
    .kanban-card {
        padding: 15px;
        margin-bottom: 12px;
        min-height: 80px;
    }
}

.kanban-card .edit-icon {
    position: absolute;
    top: 8px;
    right: 8px;
    color: #666;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 10;
}

.kanban-card:hover .edit-icon {
    opacity: 1;
}

.kanban-card .edit-icon:hover {
    color: #007bff;
}

.kanban-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.kanban-card.ui-sortable-helper {
    transform: rotate(5deg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.kanban-card.dragging {
    opacity: 0.6;
    cursor: grabbing;
}

.kanban-card-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 8px;
    color: #333;
    line-height: 1.2;
}

.kanban-card-meta {
    font-size: 12px;
    color: #666;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
}

.kanban-card-footer {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 5px;
    justify-content: space-between;
}

.kanban-card-footer .btn {
    font-size: 11px;
    padding: 4px 8px;
    flex: 1;
}

.kanban-card-footer .btn i {
    font-size: 12px;
}

.kanban-card-type {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.type-L { background-color: #e3f2fd; color: #1976d2; }
.type-V { background-color: #f3e5f5; color: #7b1fa2; }
.type-YT { background-color: #ffebee; color: #d32f2f; }
.type-A { background-color: #e8f5e8; color: #388e3c; }
.type-S { background-color: #fff3e0; color: #f57c00; }

.kanban-column[data-status="EP"] .kanban-column-header { background-color: #fff3cd; color: #856404; }
.kanban-column[data-status="AT"] .kanban-column-header { background-color: #d4edda; color: #155724; }
.kanban-column[data-status="TD"] .kanban-column-header { background-color: #cce5ff; color: #004085; }
.kanban-column[data-status="RT"] .kanban-column-header { background-color: #f8d7da; color: #721c24; }
.kanban-column[data-status="PP"] .kanban-column-header { background-color: #d1ecf1; color: #0c5460; }
.kanban-column[data-status="PB"] .kanban-column-header { background-color: #d4edda; color: #155724; }
.kanban-column[data-status="AC"] .kanban-column-header { background-color: #e2e3e5; color: #383d41; }

.kanban-empty {
    text-align: center;
    color: #999;
    font-style: italic;
    padding: 40px 20px;
    border: 2px dashed #ddd;
    border-radius: 8px;
    margin-top: 20px;
}

.ui-sortable-placeholder {
    background-color: #e9ecef;
    border: 2px dashed #adb5bd;
    border-radius: 6px;
    height: 80px;
    margin-bottom: 10px;
    visibility: visible !important;
}

.ui-sortable-placeholder:before {
    content: "Solte o card aqui";
    display: block;
    text-align: center;
    line-height: 76px;
    color: #6c757d;
    font-style: italic;
}

/* Loading indicator */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.success-feedback {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 10px;
    animation: fadeOut 3s forwards;
}

.error-feedback {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 10px;
}

@keyframes fadeOut {
    0%, 50% { opacity: 1; }
    100% { opacity: 0; }
}

/* Add Card Button */
.add-card-btn {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    background-color: #fff;
    border: 2px dashed #ccc;
    border-radius: 6px;
    color: #666;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.add-card-btn:hover {
    border-color: #007bff;
    color: #007bff;
    background-color: #f8f9ff;
}

.add-card-btn i {
    font-size: 16px;
}

/* Modal customizations */
.modal-dialog {
    max-width: 600px;
}

.form-group {
    margin-bottom: 1rem;
}

.form-control {
    width: 100%;
}

/* Custom styling for add palestrante button in Chosen dropdown */
.chosen-results .no-results .add-palestrante-btn {
    font-size: 11px;
    padding: 2px 8px;
    margin-left: 5px;
    border: none;
    border-radius: 3px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.chosen-results .no-results .add-palestrante-btn:hover {
    background-color: #0056b3;
}

.chosen-results .no-results {
    padding: 8px;
    color: #666;
}
</style>
{{end}}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="bi bi-kanban"></i> Kanban - Status de Aprovação</h2>
            <p class="text-muted">Arraste os cards entre as colunas para alterar o status de aprovação</p>
            <p class="text-muted d-md-none"><small><i class="bi bi-hand-index-thumb"></i> Toque e segure por um momento antes de arrastar no celular</small></p>
            <div id="feedback-area"></div>
        </div>
    </div>
    
    <div class="kanban-board">
        {{for status_code, status_name in aprovacoes:}}
            <div class="kanban-column" data-status="{{=status_code}}">
                <div class="kanban-column-header">
                    {{=status_name}}
                    <small class="d-block mt-1">({{=len(kanban_data.get(status_code, {}).get('videos', []))}} items)</small>
                </div>
                
                <div class="kanban-cards" data-status="{{=status_code}}">
                    {{videos = kanban_data.get(status_code, {}).get('videos', [])}}
                    {{if videos:}}
                        {{for video in videos:}}
                            <div class="kanban-card" data-video-id="{{=video['media_video']['id']}}">
                                <i class="bi bi-pencil-square edit-icon" onclick="editCard({{=video['media_video']['id']}}); event.stopPropagation();" title="Editar card"></i>
                                <div class="kanban-card-title">{{=video['media_video']['titulo'][:50]}}{{='...' if len(video['media_video']['titulo']) > 50 else ''}}</div>
                                
                                <div class="kanban-card-meta">
                                    <span class="kanban-card-type type-{{=video['media_video']['tipo_media']}}">
                                        {{=dict(tipos_media).get(video['media_video']['tipo_media'], video['media_video']['tipo_media'])}}
                                    </span>
                                    <small>{{=video['media_video']['lancado'].strftime('%d/%m/%Y') if video['media_video']['lancado'] else ''}}</small>
                                </div>
                                
                                {{if video['palestrante']['nome']:}}
                                    <div style="font-size: 11px; color: #888; margin-top: 5px;">
                                        <i class="bi bi-person-fill"></i> {{=video['palestrante']['nome']}}
                                    </div>
                                {{pass}}
                                
                                {{if video['categoria']['nome']:}}
                                    <div style="font-size: 11px; color: #888; margin-top: 2px;">
                                        <i class="bi bi-tag-fill"></i> {{=video['categoria']['nome']}}
                                    </div>
                                {{pass}}
                                
                                {{if video.get('auth_user') and video['auth_user']['nome']:}}
                                    <div style="font-size: 11px; color: #007bff; margin-top: 2px;">
                                        <i class="bi bi-pencil-square"></i> {{=video['auth_user']['nome']}}
                                    </div>
                                {{pass}}
                                
                                <!-- Card Footer with Action Buttons -->
                                <div class="kanban-card-footer">
                                    <a href="{{=URL('media','edit', args=video['media_video']['id'])}}" class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="bi bi-pencil"></i> Editar
                                    </a>
                                    {{if video['media_video']['arquivo']:}}
                                        <button class="btn btn-sm btn-outline-success publish-btn" 
                                                data-video-id="{{=video['media_video']['id']}}"
                                                data-video-file="{{=video['media_video']['arquivo']}}"
                                                title="Publicar no WhatsApp"
                                                onclick="showPublishModal({{=video['media_video']['id']}}, '{{=video['media_video']['arquivo']}}'); event.stopPropagation();">
                                            <i class="bi bi-send"></i> Publicar
                                        </button>
                                    {{pass}}
                                </div>
                            </div>
                        {{pass}}
                    {{else:}}
                        <div class="kanban-empty">
                            Nenhum item nesta coluna
                        </div>
                    {{pass}}
                </div>

                <!-- Add Card Button -->
                <div class="add-card-btn" data-status="{{=status_code}}" onclick="showAddCardModal('{{=status_code}}', '{{=status_name}}')">
                    <i class="bi bi-plus-circle"></i>
                    Adicionar Card
                </div>
            </div>
        {{pass}}
    </div>
</div>

<!-- Add Card Modal -->
<div class="modal fade" id="addCardModal" tabindex="-1" role="dialog" aria-labelledby="addCardModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCardModalLabel">Adicionar Novo Card</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addCardForm">
                    <input type="hidden" id="selectedStatus" name="status" value="">
                    <input type="hidden" id="cardId" name="card_id" value="">
                    
                    <div class="form-group">
                        <label for="cardTitle">Título *</label>
                        <input type="text" class="form-control" id="cardTitle" name="titulo" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="cardDescription">Resenha</label>
                        <textarea class="form-control" id="cardDescription" name="resenha" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cardType">Tipo de Mídia *</label>
                                <select class="form-control" id="cardType" name="tipo_media" required>
                                    {{for code, name in tipos_media:}}
                                        <option value="{{=code}}">{{=name}}</option>
                                    {{pass}}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="cardCategory">Categoria</label>
                                <select class="form-control" id="cardCategory" name="categoria">
                                    <option value="">Selecione uma categoria</option>
                                    {{for categoria in categorias:}}
                                        <option value="{{=categoria.id}}">{{=categoria.nome}}</option>
                                    {{pass}}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cardSpeaker">Palestrante</label>
                        <select class="form-control" id="cardSpeaker" name="palestrante">
                            <option value="">Selecione um palestrante</option>
                            {{for palestrante in palestrantes:}}
                                <option value="{{=palestrante.id}}">{{=palestrante.nome}}</option>  
                            {{pass}}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="cardEditor">Editor Responsável</label>
                        <select class="form-control" id="cardEditor" name="editor_responsavel">
                            <option value="">Selecione um editor</option>
                            {{for editor in editores:}}
                                <option value="{{=editor.id}}">{{=editor.nome}}</option>  
                            {{pass}}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="cardLink">Link</label>
                        <input type="url" class="form-control" id="cardLink" name="link" placeholder="https://...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="modalActionButton" onclick="saveCard()">Adicionar Card</button>
            </div>
        </div>
    </div>
</div>

<!-- Publish Modal -->
<div class="modal fade" id="publishModal" tabindex="-1" role="dialog" aria-labelledby="publishModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="publishModalLabel">Publicar Vídeo no WhatsApp</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="publishVideoId" value="">
                <input type="hidden" id="publishVideoFile" value="">
                
                <div class="form-group">
                    <label for="publishGroup">Selecione o Grupo do WhatsApp *</label>
                    <select class="form-control" id="publishGroup" required>
                        <option value="">Selecione um grupo...</option>
                        {{for grupo in grupos:}}
                            <option value="{{=grupo.group_id}}" data-gp-id="{{=grupo.id}}">{{=grupo.group_name}}</option>
                        {{pass}}
                    </select>
                </div>
                
                <div id="publishFeedback"></div>
                
                <div id="publishLoader" style="display: none; text-align: center; padding: 20px;">
                    <img src="{{=URL('static','images/loader.gif')}}" style="height: 50px;" alt="Carregando...">
                    <p>Publicando vídeo... Por favor aguarde.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="publishButton" onclick="publishVideo()">
                    <i class="bi bi-send"></i> Publicar
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{=URL('static','js/jquery.ui.touch-punch.min.js')}}"></script>
<script>
$(document).ready(function() {
    // Detect if mobile device
    var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    
    // Initialize sortable functionality with mobile-optimized settings
    $(".kanban-cards").sortable({
        connectWith: ".kanban-cards",
        placeholder: "ui-sortable-placeholder",
        cursor: "move",
        tolerance: "pointer",
        distance: isMobile ? 10 : 5, // Increased distance for mobile to prevent accidental drags
        delay: isMobile ? 200 : 0, // Add delay on mobile for better touch detection
        start: function(e, ui) {
            ui.placeholder.height(ui.item.height());
            ui.item.addClass('dragging');
            $(this).addClass('loading');
            
            // On mobile, add a visual indicator
            if (isMobile) {
                ui.item.css('opacity', '0.6');
            }
        },
        stop: function(e, ui) {
            $(this).removeClass('loading');
            ui.item.removeClass('dragging');
            ui.item.css('opacity', '1');
            
            var videoId = ui.item.data('video-id');
            var newStatus = ui.item.closest('.kanban-cards').data('status');
            
            // Update the video status via AJAX
            $.ajax({
                url: '{{=URL("media", "kanban_update")}}',
                method: 'POST',
                data: {
                    video_id: videoId,
                    new_status: newStatus
                },
                success: function(response) {
                    if (response.success) {
                        showFeedback('success', response.message);
                        updateColumnCounts();
                        
                        // Log the update for debugging (only in development)
                        if (window.console && window.console.log) {
                            console.log('Video ' + videoId + ' moved to status: ' + newStatus);
                        }
                    } else {
                        showFeedback('error', 'Erro: ' + response.message);
                        // Revert the move if failed
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    }
                },
                error: function() {
                    showFeedback('error', 'Erro de conexão. Tente novamente.');
                    // Revert the move if failed
                    location.reload();
                }
            });
        }
    }).disableSelection();
});

// Show feedback messages
function showFeedback(type, message) {
    var feedbackClass = type === 'success' ? 'success-feedback' : 'error-feedback';
    var feedbackHtml = '<div class="' + feedbackClass + '">' + message + '</div>';
    $('#feedback-area').html(feedbackHtml);
    
    if (type === 'success') {
        setTimeout(function() {
            $('#feedback-area').empty();
        }, 3000);
    }
}

// Update column counts
function updateColumnCounts() {
    $('.kanban-column').each(function() {
        var count = $(this).find('.kanban-card').length;
        $(this).find('.kanban-column-header small').text('(' + count + ' items)');
        
        // Show/hide empty message
        var emptyDiv = $(this).find('.kanban-empty');
        if (count === 0 && emptyDiv.length === 0) {
            $(this).find('.kanban-cards').append('<div class="kanban-empty">Nenhum item nesta coluna</div>');
        } else if (count > 0 && emptyDiv.length > 0) {
            emptyDiv.remove();
        }
    });
}

// Show add card modal
function showAddCardModal(statusCode, statusName) {
    $('#cardId').val(''); // Clear card ID for add mode
    $('#selectedStatus').val(statusCode);
    $('#addCardModalLabel').text('Adicionar Novo Card - ' + statusName);
    $('#addCardForm')[0].reset();
    $('#selectedStatus').val(statusCode); // Reset clears this, so set again
    $('#modalActionButton').text('Adicionar Card');
    
    // Update chosen selectors after reset
    $('#cardSpeaker').trigger('chosen:updated');
    
    $('#addCardModal').modal('show');
}

// Edit card function
function editCard(videoId) {
    // Get card data via AJAX
    $.ajax({
        url: '{{=URL("media", "kanban_get_card")}}',
        method: 'POST',
        data: { video_id: videoId },
        success: function(response) {
            if (response.success) {
                // Populate form with existing data
                $('#cardId').val(response.data.id);
                $('#cardTitle').val(response.data.titulo);
                $('#cardDescription').val(response.data.resenha);
                $('#cardType').val(response.data.tipo_media);
                $('#cardCategory').val(response.data.categoria);
                $('#cardSpeaker').val(response.data.palestrante);
                $('#cardEditor').val(response.data.editor_responsavel);
                $('#cardLink').val(response.data.link);
                $('#selectedStatus').val(response.data.aprovacao);
                
                // Update chosen selectors
                $('#cardSpeaker').trigger('chosen:updated');
                
                // Update modal title and button
                $('#addCardModalLabel').text('Editar Card');
                $('#modalActionButton').text('Salvar Alterações');
                
                // Show modal
                $('#addCardModal').modal('show');
            } else {
                showFeedback('error', 'Erro ao carregar dados do card: ' + response.message);
            }
        },
        error: function() {
            showFeedback('error', 'Erro de conexão ao carregar dados do card.');
        }
    });
}

// Unified save function (handles both add and edit)
function saveCard() {
    var cardId = $('#cardId').val();
    var isEdit = cardId && cardId.trim() !== '';
    
    if (isEdit) {
        updateCard();
    } else {
        addNewCard();
    }
}

// Update existing card
function updateCard() {
    var formData = {
        video_id: $('#cardId').val(),
        titulo: $('#cardTitle').val(),
        resenha: $('#cardDescription').val(),
        tipo_media: $('#cardType').val(),
        categoria: $('#cardCategory').val(),
        palestrante: $('#cardSpeaker').val(),
        editor_responsavel: $('#cardEditor').val(),
        link: $('#cardLink').val(),
        aprovacao: $('#selectedStatus').val()
    };
    
    // Basic validation
    if (!formData.titulo.trim()) {
        showFeedback('error', 'Título é obrigatório');
        return;
    }
    
    if (!formData.tipo_media) {
        showFeedback('error', 'Tipo de mídia é obrigatório');
        return;
    }
    
    // Show loading state
    $('#modalActionButton').prop('disabled', true).text('Salvando...');
    
    // Submit via AJAX
    $.ajax({
        url: '{{=URL("media", "kanban_edit_card")}}',
        method: 'POST',
        data: formData,
        success: function(response) {
            if (response.success) {
                showFeedback('success', 'Card atualizado com sucesso!');
                $('#addCardModal').modal('hide');
                
                // Reload the page to show the updated card
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                showFeedback('error', 'Erro: ' + response.message);
            }
        },
        error: function() {
            showFeedback('error', 'Erro de conexão. Tente novamente.');
        },
        complete: function() {
            $('#modalActionButton').prop('disabled', false).text('Salvar Alterações');
        }
    });
}

// Add new card
function addNewCard() {
    var form = $('#addCardForm');
    var formData = {
        titulo: $('#cardTitle').val(),
        resenha: $('#cardDescription').val(),
        tipo_media: $('#cardType').val(),
        categoria: $('#cardCategory').val(),
        palestrante: $('#cardSpeaker').val(),
        editor_responsavel: $('#cardEditor').val(),
        link: $('#cardLink').val(),
        aprovacao: $('#selectedStatus').val()
    };
    
    // Basic validation
    if (!formData.titulo.trim()) {
        showFeedback('error', 'Título é obrigatório');
        return;
    }
    
    if (!formData.tipo_media) {
        showFeedback('error', 'Tipo de mídia é obrigatório');
        return;
    }
    
    // Show loading state
    $('#modalActionButton').prop('disabled', true).text('Adicionando...');
    
    // Submit via AJAX
    $.ajax({
        url: '{{=URL("media", "kanban_add_card")}}',
        method: 'POST',
        data: formData,
        success: function(response) {
            if (response.success) {
                showFeedback('success', 'Card adicionado com sucesso!');
                $('#addCardModal').modal('hide');
                
                // Reload the page to show the new card
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                showFeedback('error', 'Erro: ' + response.message);
            }
        },
        error: function() {
            showFeedback('error', 'Erro de conexão. Tente novamente.');
        },
        complete: function() {
            $('#modalActionButton').prop('disabled', false).text('Adicionar Card');
        }
    });
}
</script>

<script src="{{=URL('static','plugins/chosen/chosen.jquery.min.js')}}"></script>
<script>
// Initialize Chosen for the palestrante select with tagging support
$(document).ready(function() {
    initChosenPalestrante();
});

function escapeHtml(text) {
    if (!text) {
        return '';
    }
    return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function initChosenPalestrante() {
    $('#cardSpeaker').chosen({
        width: "100%",
        placeholder_text_single: "Digite para pesquisar ou adicionar novo palestrante...",
        no_results_text: "Nenhum resultado encontrado para",
        allow_single_deselect: true
    });

    // Substitui a mensagem padrão do Chosen quando não houver resultados
    $('#cardSpeaker').on('chosen:no_results', function(event, params) {
        var searchField = params.chosen.search_field;
        if (!searchField) {
            return;
        }

        var searchText = searchField.val().trim();
        if (!searchText) {
            return;
        }

        var escapedSearch = escapeHtml(searchText);
        var messageHtml = 'Nenhum resultado encontrado para "<strong>' + escapedSearch + '</strong>". <button type="button" class="add-palestrante-btn btn btn-sm btn-primary" style="margin-left: 5px;">Adicionar</button>';

        var $noResults = params.chosen.container.find('.no-results');
        if ($noResults.length === 0) {
            return;
        }

        $noResults.html(messageHtml);
        $noResults.find('.add-palestrante-btn').attr('data-nome', searchText);
    });

    // Handle click on the "Add" button
    $('#cardSpeaker_chosen').on('click', '.add-palestrante-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        var nome = $(this).attr('data-nome');
        if (nome && nome.trim()) {
            addNewPalestrante(nome.trim());
        }
    });
}
    
function addNewPalestrante(nome) {
    if (!nome || nome.trim() === '') {
        return;
    }
    
    nome = nome.trim();
    
    // Clear the search field to avoid confusion
    $('#cardSpeaker_chosen .search-field input').val('');
    
    // Show loading feedback
    var $chosen = $('#cardSpeaker_chosen');
    $chosen.addClass('chosen-disabled');
    
    $.ajax({
        url: '{{=URL("media", "add_palestrante")}}',
        method: 'POST',
        data: { nome: nome },
        success: function(response) {
            if (response.success) {
                // Check if option already exists
                var existingOption = $('#cardSpeaker option[value="' + response.palestrante_id + '"]');
                
                if (existingOption.length === 0) {
                    // Add new option to select
                    var newOption = $('<option value="' + response.palestrante_id + '" selected>' + response.nome + '</option>');
                    $('#cardSpeaker').append(newOption);
                } else {
                    // Select existing option
                    existingOption.prop('selected', true);
                }
                
                // Update chosen and close dropdown
                $('#cardSpeaker').trigger('chosen:updated');
                $('#cardSpeaker').trigger('chosen:close');
                
                // Show success feedback
                if (response.message === 'Palestrante já existia') {
                    showFeedback('success', 'Palestrante "' + response.nome + '" selecionado!');
                } else {
                    showFeedback('success', 'Palestrante "' + response.nome + '" adicionado com sucesso!');
                }
            } else {
                showFeedback('error', 'Erro ao adicionar palestrante: ' + response.message);
            }
        },
        error: function() {
            showFeedback('error', 'Erro de conexão ao adicionar palestrante.');
        },
        complete: function() {
            $chosen.removeClass('chosen-disabled');
        }
    });
}

// Show publish modal
function showPublishModal(videoId, videoFile) {
    $('#publishVideoId').val(videoId);
    $('#publishVideoFile').val(videoFile);
    $('#publishGroup').val('');
    $('#publishFeedback').empty();
    $('#publishLoader').hide();
    $('#publishButton').prop('disabled', false).show();
    $('#publishModal').modal('show');
}

// Publish video to WhatsApp
function publishVideo() {
    var videoId = $('#publishVideoId').val();
    var videoFile = $('#publishVideoFile').val();
    var groupId = $('#publishGroup').val();
    var gpid = $('#publishGroup').find(':selected').attr('data-gp-id');
    
    // Validation
    if (!groupId) {
        showPublishFeedback('error', 'Por favor, selecione um grupo do WhatsApp');
        return;
    }
    
    if (!videoFile) {
        showPublishFeedback('error', 'Este vídeo não possui arquivo para publicação');
        return;
    }
    
    // Build URL for postar_wa endpoint
    var url = '{{=URL("media", "postar_wa")}}/' + videoId + '/' + groupId + '/' + gpid + '/' + videoFile;
    
    // Show loader and disable button
    $('#publishLoader').show();
    $('#publishButton').prop('disabled', true);
    $('#publishFeedback').empty();
    
    // Make AJAX request
    $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            $('#publishLoader').hide();
            
            if (data.success) {
                showPublishFeedback('success', 'Vídeo publicado com sucesso!');
                
                // Close modal after 2 seconds and reload page to show updated card position
                setTimeout(function() {
                    $('#publishModal').modal('hide');
                    location.reload();
                }, 2000);
            } else {
                showPublishFeedback('error', 'Erro ao publicar: ' + (data.erro || 'Erro desconhecido'));
                $('#publishButton').prop('disabled', false);
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            $('#publishLoader').hide();
            showPublishFeedback('error', 'Erro de conexão: ' + textStatus);
            $('#publishButton').prop('disabled', false);
        }
    });
}

// Show feedback in publish modal
function showPublishFeedback(type, message) {
    var feedbackClass = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
    var feedbackHtml = '<div class="' + feedbackClass + '">' + message + '</div>';
    $('#publishFeedback').html(feedbackHtml);
}
</script>
